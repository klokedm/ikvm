<Project>

  <PropertyGroup>
    <OpenJdkDir>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)\openjdk-8u45-b14'))</OpenJdkDir>
    <IkvmcExe>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)\..\bin\$(Configuration)\netcoreapp3.1\ikvmc.exe'))</IkvmcExe>
    <OpenJdkToolsGenRsp>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)\tools.gen.rsp'))</OpenJdkToolsGenRsp>
  </PropertyGroup>

  <Target Name="RunBuild" BeforeTargets="CoreCompile">
    <Copy SourceFiles="$(MSBuildThisFileDirectory)\tools.rsp" DestinationFiles="$(OpenJdkToolsGenRsp)" />
    <ItemGroup>
      <TransformOpenJdkDir Include="$(OpenJdkToolsGenRsp)">
        <Find>@OPENJDK@</Find>
        <ReplaceWith>$(OpenJdkDir)</ReplaceWith>
        <Options>Singleline</Options>
      </TransformOpenJdkDir>
    </ItemGroup>
    <RegexTransform Items="@(TransformOpenJdkDir)" />
    <Exec Command="$(IkvmcExe) -version:$(AssemblyVersion) -compressresources -opt:fields -strictfinalfieldsemantics -removeassertions -target:library -sharedclassloader -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\Microsoft.Win32.Primitives.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\mscorlib.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\netstandard.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.AppContext.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Buffers.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Collections.Concurrent.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Collections.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Collections.NonGeneric.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Collections.Specialized.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.ComponentModel.Composition.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.ComponentModel.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.ComponentModel.EventBasedAsync.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.ComponentModel.Primitives.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.ComponentModel.TypeConverter.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Configuration.ConfigurationManager.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Console.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Core.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Data.Common.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Data.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Data.Odbc.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Diagnostics.Contracts.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Diagnostics.Debug.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Diagnostics.FileVersionInfo.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Diagnostics.Process.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Diagnostics.StackTrace.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Diagnostics.TextWriterTraceListener.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Diagnostics.Tools.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Diagnostics.TraceSource.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Diagnostics.Tracing.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Drawing.Common.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Drawing.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Drawing.Primitives.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Dynamic.Runtime.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Globalization.Calendars.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Globalization.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Globalization.Extensions.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.Compression.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.Compression.FileSystem.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.Compression.ZipFile.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.FileSystem.AccessControl.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.FileSystem.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.FileSystem.DriveInfo.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.FileSystem.Primitives.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.FileSystem.Watcher.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.IsolatedStorage.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.MemoryMappedFiles.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.Pipes.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.IO.UnmanagedMemoryStream.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Linq.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Linq.Expressions.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Linq.Parallel.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Linq.Queryable.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Memory.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.Http.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.NameResolution.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.NetworkInformation.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.Ping.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.Primitives.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.Requests.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.Security.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.Sockets.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.WebHeaderCollection.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.WebSockets.Client.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Net.WebSockets.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Numerics.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Numerics.Vectors.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.ObjectModel.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Reflection.DispatchProxy.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Reflection.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Reflection.Emit.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Reflection.Emit.ILGeneration.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Reflection.Emit.Lightweight.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Reflection.Extensions.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Reflection.Primitives.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Resources.Reader.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Resources.ResourceManager.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Resources.Writer.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.CompilerServices.VisualC.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.Extensions.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.Handles.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.InteropServices.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.InteropServices.RuntimeInformation.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.Numerics.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.Serialization.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.Serialization.Formatters.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.Serialization.Json.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.Serialization.Primitives.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Runtime.Serialization.Xml.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.AccessControl.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Claims.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Cryptography.Algorithms.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Cryptography.Csp.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Cryptography.Encoding.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Cryptography.Pkcs.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Cryptography.Primitives.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Cryptography.X509Certificates.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Permissions.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Principal.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.Principal.Windows.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Security.SecureString.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.ServiceModel.Web.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Text.Encoding.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Text.Encoding.Extensions.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Text.RegularExpressions.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Threading.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Threading.Overlapped.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Threading.Tasks.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Threading.Tasks.Extensions.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Threading.Tasks.Parallel.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Threading.Thread.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Threading.ThreadPool.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Threading.Timer.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Transactions.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.ValueTuple.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Web.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Windows.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Xml.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Xml.Linq.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Xml.ReaderWriter.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Xml.Serialization.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Xml.XDocument.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Xml.XmlDocument.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Xml.XmlSerializer.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Xml.XPath.dll -r:..\bin\$(Configuration)\netstandard2.1\publish\refs\System.Xml.XPath.XDocument.dll -r:IKVM.Runtime.dll -w4 -noparameterreflection @tools.gen.rsp" />
    <Copy SourceFiles="$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)\..\bin\IKVM.OpenJDK.Tools.dll'))" DestinationFolder="$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)\..\bin\$(Configuration)\$(TargetFramework)'))" />
  </Target>

  <Target Name="Clean">
    <ItemGroup>
      <CleanFiles Include="$(OpenJdkToolsGenRsp)" />
      <CleanFiles Include="$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)\..\bin\IKVM.OpenJDK.Tools.dll'))" />
      <CleanFiles Include="$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)\..\bin\$(Configuration)\$(TargetFramework)\IKVM.OpenJDK.Tools.dll'))" />
    </ItemGroup>
    <Delete Files="@(CleanFiles)" />
  </Target>

  <Target Name="Rebuild">
    <CallTarget Targets="Clean;RunBuild" />
  </Target>

</Project>